# Rica - Claude Code Progress Log

## Project Overview

**Name**: rica (Reports for ICA)
**Version**: 2.0.2
**Purpose**: React-based interactive visualization tool for multi-echo fMRI ICA component analysis from tedana/ME-ICA outputs.

### Main Libraries (v2.0.0)
- React 18.2.0 (functional components with hooks)
- visx (D3 + React visualization library for scatter plots, pie charts)
- Tailwind CSS 3.4.0 (styling)
- papaparse 5.4.1 (CSV/TSV parsing)
- react-hotkeys-hook 4.4.4 (keyboard shortcuts)
- Custom tab implementation (replaced @reach/tabs)

### Component Structure (v2.0.0)
```
src/
  index.js              - Main App component (functional, hooks, lazy loading)
  Mobile.js             - Mobile fallback view (<1024px)
  TabFunctions.js       - Animated tab components
  TabComponents.js      - Custom tabs context and components
  LoadingSpinner.js     - Reusable loading spinner
  Carpets/
    Carpets.js          - Carpet plot display with dropdown selector
  Info/
    Info.js             - Report info display tab
  Plots/
    Plots.js            - ICA visualization (visx scatter plots, pie chart)
    ScatterPlot.js      - visx scatter plot with zoom/pan/tooltips
    PieChart.js         - visx donut chart with hover effects
    PlotUtils.js        - Data parsing and color management utilities
    ToggleSwitch.js     - Classification toggle (accepted/rejected)
    ResetAndSave.js     - Reset/Save action buttons
  PopUps/
    IntroPopUp.js       - File upload dialog with Promise-based loading
    AboutPopUp.js       - About modal with version info
  styles/
    tailwind.css        - Tailwind directives
    output.css          - Compiled Tailwind output
```

### Build System
- Create React App (react-scripts 5.0.0)
- PostCSS with Tailwind CSS JIT compilation
- Gulp 3.9.1 for post-build asset inlining (single-file HTML distribution)

### Data Formats Expected
- `*_metrics.tsv`: Component metrics table (not PCA metrics)
- `comp_*.png`: Individual component figure images
- `*.svg`: Carpet plot visualizations
- `report.txt`: Tedana text report
- `tedana_20*.tsv`: Metadata with folder path

---

## Session 0 - Initializer (2025-12-14)

### Files Inspected
1. **package.json** - Dependencies, scripts, version info
2. **src/index.js** - Main App component with state management
3. **src/Plots/Plots.js** - Core ICA visualization logic (~480 lines)
4. **src/Plots/PlotUtils.js** - Data parsing functions
5. **src/Plots/PlotOptions.js** - Chart.js configuration
6. **src/Carpets/Carpets.js** - Carpet plot display
7. **src/PopUps/IntroPopUp.js** - File loading and data parsing
8. **src/Info/Info.js** - Report display
9. **src/Mobile.js** - Mobile fallback
10. **src/TabFunctions.js** - Animated tabs
11. **tailwind.config.js** - Tailwind configuration
12. **postcss.config.js** - PostCSS configuration
13. **gulpfile.js** - Build post-processing
14. **.gitignore** - Git ignore patterns

### Important Findings

#### Code Quality Issues
1. **Console.log statements in production code**: Multiple `console.log` calls remain in `index.js` and `IntroPopUp.js` (data loading debugging)
2. **Deprecated lifecycle methods**: `componentWillMount` used in `index.js` (should be `componentDidMount`)
3. **Typo in variable names**: `rejedtecColor` instead of `rejectedColor` in PlotUtils.js and Plots.js
4. **JSX attribute errors**: `class` used instead of `className` in PopUp SVG icons
5. **Missing key props**: `<span>` elements in ToggleSwitch.js missing key props in map()

#### Dependency Issues
1. **Gulp 3.9.1 is severely outdated**: Current version is 4.x, v3 has known vulnerabilities
2. **Tailwind config uses deprecated `purge` key**: Should be `content` in Tailwind 3.x
3. **No Node.js version specified**: Missing `.nvmrc` or `engines` field
4. **Some peer dependency warnings likely**: React 17 vs newer library versions

#### Missing Infrastructure
1. **No test files**: No `__tests__/` directory, no `*.test.js` files
2. **No dedicated lint/format scripts**: Only eslint from react-app config
3. **No CI/CD configuration**: No GitHub Actions, CircleCI, etc.
4. **No environment variable documentation**: `.env.example` missing

#### Architecture Observations
1. **All class components**: Could benefit from React Hooks refactor for cleaner state management
2. **Nested setTimeout chains**: Data loading in index.js uses nested timeouts (fragile)
3. **No loading states**: User doesn't see progress during 5-second data load delay
4. **No error boundaries**: File loading errors could crash the app

### Files Created
1. **features.json** - 22 features covering all visualization workflows
2. **claude-progress.txt** - This progress tracking file
3. **scripts/init_env.sh** - Environment setup script
4. **scripts/dev.sh** - Development server script
5. **scripts/build.sh** - Production build script
6. **scripts/test.sh** - Test runner script
7. **scripts/lint.sh** - Linting script
8. **.nvmrc** - Node.js version specification (v18)

### Files Modified
1. **package.json** - Added `engines` field, `lint`, `lint:fix`, and `build:inline` scripts
2. **.gitignore** - Added IDE directories, .env, and OS files

### Known Limitations and TODOs

#### High Priority
- [ ] Add unit tests for PlotUtils.js (data parsing functions)
- [ ] Add integration tests for file loading workflow
- [x] Fix deprecated `componentWillMount` usage *(Completed in v2.0.0 - converted to useEffect)*
- [x] Remove console.log statements or add proper logging *(Completed in v2.0.0)*
- [x] Update Gulp to v4 or replace with modern bundler post-processing *(Completed in v2.0.0)*

#### Medium Priority
- [x] Add loading indicator during data parsing *(Completed in v2.0.0 - progress bar added)*
- [ ] Add error handling for malformed input files
- [x] Fix JSX attribute errors (`class` -> `className`) *(Completed in v2.0.0)*
- [x] Add .nvmrc file for Node.js version management *(Already exists)*
- [x] Update Tailwind config from `purge` to `content` *(Completed in v2.0.0)*
- [ ] Add Prettier for code formatting consistency

#### Low Priority
- [x] Consider migrating class components to functional components with hooks *(Completed in v2.0.0 - all components converted)*
- [ ] Add TypeScript support for better maintainability
- [ ] Improve mobile experience (currently just shows redirect message)
- [ ] Add component-level documentation/JSDoc comments
- [ ] Add Storybook for component development

### Open Questions for Future Sessions
1. ~~Is Recharts intentionally included but unused, or should it be removed?~~ **RESOLVED: Removed in v2.0.0**
2. What's the expected behavior when loading folders with missing files?
3. ~~Should the "5 second delay" in data loading be replaced with actual async completion detection?~~ **RESOLVED: Replaced with Promise-based loading in v2.0.0**
4. Are there plans to support additional ICA tools beyond tedana?

---

## Session 1 - Major Modernization (2025-12-14)

### Goals
- Modernize the app for better performance and snappier UI
- Upgrade to React 18 with functional components
- Remove 5-second data loading delay
- Add loading progress indicator
- Enable smooth chart animations
- Fix dependency bloat

### Changes Made

#### Package Updates (package.json)
- **React**: 17.0.2 → 18.2.0
- **Chart.js**: 3.5.0 → 4.4.1
- **react-chartjs-2**: 3.0.4 → 5.2.0
- **Tailwind CSS**: 2.2.19 → 3.4.0
- **Gulp**: 3.9.1 → 4.0.2
- **Removed**: @blueprintjs/core, recharts, react-icons, @reach/tabs, styled-components, react-papaparse, react-hotkeys
- **Added**: papaparse, react-helmet-async, react-hotkeys-hook

#### Component Rewrites (Class → Functional)
1. **src/index.js** - Main App component with hooks, lazy loading, createRoot API
2. **src/Plots/Plots.js** - Memoized chart data, useHotkeys, ref-based click handlers
3. **src/PopUps/IntroPopUp.js** - Promise-based file reading, progress bar
4. **src/Carpets/Carpets.js** - Functional component
5. **src/Info/Info.js** - Functional component
6. **src/Plots/ToggleSwitch.js** - Functional component (removed styled-components)
7. **src/Plots/ResetAndSave.js** - Functional component
8. **src/PopUps/AboutPopUp.js** - Functional component
9. **src/Mobile.js** - Functional component

#### New Files Created
- **src/LoadingSpinner.js** - Reusable loading spinner component
- **src/TabComponents.js** - Custom tabs context and components
- **src/TabFunctions.js** - Animated tabs (replaced @reach/tabs)

#### Files Removed
- **src/Plots/ToggleStyles.js** - Replaced with inline Tailwind
- **src/Carpets/CarpetOption.js** - Simplified into Carpets.js

#### Configuration Updates
- **tailwind.config.js** - Updated for Tailwind v3 (purge → content)
- **gulpfile.js** - Updated for Gulp v4 syntax
- **PlotOptions.js** - Added smooth animations (400ms duration)

### Performance Improvements
1. **Data Loading**: Removed 5-second setTimeout, now uses Promise.all for parallel file reading
2. **Loading Feedback**: Progress bar shows file processing status
3. **Lazy Loading**: Info, Plots, Carpets tabs load on-demand with React.lazy
4. **Chart Animations**: Smooth 400ms initial animation, fast 100ms updates
5. **Memoization**: Chart options memoized to prevent unnecessary re-renders

### Bug Fixes (Session 1.1)
- Fixed navigation bar layout (Carpets tab was hidden behind New/About buttons)
- Fixed tab spacing (tabs were too spread apart with justify-around)
- Fixed chart click interactions (updated for react-chartjs-2 v5 API with refs and getElementAtEvent)

### Features Updated
- load_tedana_folder: Loading now instant with progress indicator
- select_component_scatter: Click interactions restored with v5 API
- select_component_pie: Click interactions restored with v5 API
- animated_tab_navigation: Custom implementation replaces @reach/tabs

### Issues Encountered
- Node.js v24 incompatible with fsevents/chokidar (resolved by using Node 18)
- react-chartjs-2 v5 removed direct onClick prop (resolved with refs + getElementAtEvent)
- @reach/tabs deprecated (resolved with custom TabComponents implementation)

### Next Steps
- Test all features from features.json
- Mark features as passing after verification
- Consider adding error boundaries for robustness

---

## Session 2 - visx Migration (2025-12-14)

### Goals
- Replace Chart.js with visx (Airbnb's D3 + React library) for prettier graphs
- Improve chart interactivity and visual aesthetics
- Add zoom/pan functionality to scatter plots

### Changes Made

#### Package Updates (package.json)
- **Removed**: chart.js, react-chartjs-2, chartjs-plugin-zoom
- **Added**: @visx/axis, @visx/event, @visx/grid, @visx/group, @visx/responsive, @visx/scale, @visx/shape, @visx/tooltip, @visx/zoom, d3-shape

#### New Components Created
1. **src/Plots/ScatterPlot.js** - visx-based scatter plot with:
   - Zoom/pan functionality (scroll to zoom, drag to pan, double-click to zoom in)
   - Tooltips showing component details on hover
   - Color-coded points by classification
   - Selected point highlighting with border
   - Grid lines and axis labels

2. **src/Plots/PieChart.js** - visx-based donut chart with:
   - Hover effects with scale transform
   - Tooltips showing variance percentage
   - Click handling for slice selection
   - Center text label

#### Files Modified
1. **src/Plots/Plots.js** - Rewrote to use visx components with fixed dimensions

#### Files Removed
1. **src/Plots/PlotOptions.js** - No longer needed (was Chart.js configuration)

### Technical Details
- Using fixed chart dimensions (340x300) instead of ParentSize for reliability
- All hooks called before conditional returns to comply with React rules
- Guard clauses added for invalid dimensions
- Smooth transitions on hover/select (0.15s ease-out)

### Issues Encountered
- @visx/grid package was missing initially (resolved by adding to dependencies)
- ParentSize component returning 0 dimensions (resolved by using fixed dimensions)
- React hooks rules violation when using early returns (resolved by moving guards after hooks)

### Session 2.1 - Layout and UX Updates
- Changed layout: 4 interactive plots on LEFT in 2x2 grid, brain image on RIGHT
- Changed chart backgrounds from gray (#fafafa) to white (#ffffff)
- Fixed tooltip z-index issue using `useTooltipInPortal` to render tooltips in a portal
- Made tooltips smaller and more compact
- Fixed pie chart sorting: groups by classification (accepted, rejected, ignored) then by variance descending within each group

### Next Steps
- Verify all chart interactions work correctly
- Test keyboard shortcuts (A/R/I for classification, arrow keys for navigation)
- Update features.json with passing tests

---

## Session 2.2 - UX Polish and Cleanup (2025-12-14)

### Goals
- Improve chart interaction UX
- Fix layout issues with controls
- Remove deprecated "ignored" classification
- Polish visual details

### Changes Made

#### Chart Interactions
1. **Arrow key navigation now follows pie chart order** - Components are navigated in the same order as they appear in the pie chart (grouped by classification, sorted by variance)
2. **Selected elements render on top** - In both scatter plots and pie chart, the selected element is rendered last so it's always fully visible
3. **Invisible hit areas for small pie slices** - Added 20px transparent stroke around pie slices for easier clicking on small segments

#### Layout Updates
1. **50/50 layout** - Interactive plots grid now takes 50% width, brain image takes 50% width
2. **Chart dimensions increased** - Charts now 420x380 pixels for better visibility in 2x2 grid
3. **Fixed Reset/Save button layout** - Buttons now appear inline to the right of the toggle switch (removed absolute positioning)

#### Classification Changes
1. **Removed "ignored" classification** - tedana no longer generates ignored components
   - Removed from ToggleSwitch values
   - Removed "I" keyboard shortcut
   - Updated help text from "A/R/I" to "A/R"

#### Style Fixes
1. **Icon spacing** - Reset/Save icons now have proper spacing from text (inline style marginRight: 8px)
2. **Toggle switch vertical centering** - Labels now use flexbox with `items-center justify-center` for proper vertical alignment
3. **Cursor pointer** - Toggle switch labels now show pointer cursor on hover (inline style)
4. **Fixed slider position calculation** - Changed from percentage-based to pixel-based (`index * 90px`) for 2 values

### Files Modified
1. **src/Plots/Plots.js** - Arrow key navigation, layout changes, removed "ignored"
2. **src/Plots/ScatterPlot.js** - Selected point renders last (on top)
3. **src/Plots/PieChart.js** - Selected slice renders last, invisible hit areas
4. **src/Plots/ToggleSwitch.js** - Vertical centering, cursor pointer, slider position fix
5. **src/Plots/ResetAndSave.js** - Icon spacing, removed absolute positioning

### Technical Notes
- Tailwind CSS classes like `cursor-pointer` and `mr-*` weren't being applied to FontAwesome icons and some elements; resolved by using inline styles
- SVG rendering order determines visual stacking (elements rendered last appear on top)

---

## Session 3 - Niivue Integration (2025-12-14)

### Goals
- Replace static PNG brain images with interactive Niivue 3D viewer
- Add interactive time series visualization
- Add FFT power spectrum visualization
- Synchronize all visualizations with component selection

### Changes Made

#### New Dependencies (package.json)
- `@niivue/niivue` - WebGL2-based neuroimaging viewer
- `fft.js` - Fast Fourier Transform for power spectrum computation

#### New Utility Files
1. **src/utils/tsvParser.js** - Parse mixing matrix TSV file
   - `parseMixingMatrix()` - Converts TSV to component time series array
   - `getComponentIndex()` - Maps component labels to array indices

2. **src/utils/fftUtils.js** - FFT computation utilities
   - `computePowerSpectrum()` - One-sided power spectrum from time series
   - `powerToDecibels()` - Convert power to dB scale

#### New Visualization Components
1. **src/Plots/TimeSeries.js** - visx line chart for component time series
   - Zoom/pan support with @visx/zoom
   - Hover tooltips showing TR and value
   - Blue line (#3b82f6) color scheme

2. **src/Plots/FFTSpectrum.js** - visx line chart for power spectrum
   - Computes FFT internally using fft.js (memoized)
   - X-axis: Frequency (cycles/TR)
   - Y-axis: Power with exponential notation
   - Green line (#10b981) color scheme

3. **src/Plots/BrainViewer.js** - Niivue wrapper component
   - Loads 4D NIfTI from ArrayBuffer
   - Uses `setFrame4D()` to display selected component
   - Warm colormap for z-scores
   - Multi-planar slice view
   - Loading and error states

#### Data Loading Updates (IntroPopUp.js)
- Added `readFileAsArrayBuffer()` helper
- New file patterns:
  - `*_mixing.tsv` (excluding PCA) - ICA time series
  - `*stat-z_components.nii.gz` (ICA) - 4D brain maps
- Passes `mixingMatrix` and `niftiBuffer` to parent

#### State Management (index.js)
- New state: `mixingMatrix`, `niftiBuffer`
- Passes new props to Plots component

#### Plots.js Integration
- New props: `mixingMatrix`, `niftiBuffer`
- `hasInteractiveViews` - Conditional rendering flag
- `currentTimeSeries` - Memoized time series for selected component
- Graceful fallback to PNG if NIfTI/mixing files not available

### New Layout (Right Side)
```
+---------------------------+
|   Time Series (600x180)   |
+---------------------------+
|   Brain Stat Map          |
|   (Niivue - 600x400)      |
+---------------------------+
|   FFT Spectrum (600x180)  |
+---------------------------+
```

### Files Created
- `src/utils/tsvParser.js`
- `src/utils/fftUtils.js`
- `src/Plots/TimeSeries.js`
- `src/Plots/FFTSpectrum.js`
- `src/Plots/BrainViewer.js`

### Files Modified
- `package.json` - Added @niivue/niivue, fft.js
- `src/PopUps/IntroPopUp.js` - Load mixing TSV + NIfTI
- `src/index.js` - Add state, pass props
- `src/Plots/Plots.js` - Import new components, conditional layout

### Technical Notes
- Niivue requires WebGL2 canvas
- 4D NIfTI loaded as ArrayBuffer from FileReader
- `setFrame4D(volumeId, index)` switches displayed volume
- FFT memoized to prevent expensive recomputation
- Graceful degradation if new files not present

### Test Data
Location: `/Users/eurunuela/tedana_for_rica_tests/`
- 32 ICA components
- ~200 timepoints
- 3MB NIfTI file

---

## Session 3.1 - Niivue Fixes (2025-12-14)

### Issues Addressed
1. **NIfTI loading error** - "Failed to parse NIfTI file components.nii.gz"
2. **Wrong layout order** - Brain map should be in middle, not on top
3. **Width mismatch** - Visualizations should match previous PNG width

### Changes Made

#### BrainViewer.js Fixes
- Changed from `loadVolumes()` with `buffer` property to `loadFromArrayBuffer()`
- Added Uint8Array conversion: `new Uint8Array(niftiBuffer)`
- Made `attachToCanvas()` async (added await)
```javascript
// Before (broken)
const volumeData = { url: "components.nii.gz", buffer: niftiBuffer };
await nv.loadVolumes([volumeData]);

// After (working)
const uint8Array = new Uint8Array(niftiBuffer);
await nv.loadFromArrayBuffer(uint8Array, "components.nii.gz");
```

#### Plots.js Layout Update
- Changed order: Time Series (top) → Brain Map (middle) → FFT (bottom)
- Unified width to 600px for all components
- Adjusted heights: TimeSeries 180px, BrainViewer 400px, FFTSpectrum 180px
- Changed gap from 4 to 2 for tighter stacking

### Files Modified
- `src/Plots/BrainViewer.js` - Fixed Niivue ArrayBuffer loading
- `src/Plots/Plots.js` - Updated layout order and dimensions

---

## Session 3.2 - Niivue Colormap and Display Polish (2025-12-14)

### Goals
- Implement proper RdBu colormap matching matplotlib
- Configure multiplanar view (axial, sagittal, coronal in row)
- Match visualization widths and colors with component classification
- Polish background and colormap display

### Changes Made

#### BrainViewer.js - Colormap Implementation
1. **Custom RdBu colormap** - Created two half-colormaps to match matplotlib's RdBu:
   - `white2red`: For positive values (white at 0 → red at max)
   - `blue2white`: For negative values (blue at -max → white at 0)

2. **Colormap range**: Set to 90% of absolute maximum for symmetric display

3. **Multiplanar configuration**:
   - `setSliceType(nv.sliceTypeMultiplanar)` - Enable multiplanar view
   - `setMultiplanarLayout(3)` - ROW layout (axial, sagittal, coronal side by side)
   - `multiplanarShowRender = 0` - Disable 3D render
   - `multiplanarEqualSize = true` - Equal size panels
   - `multiplanarPadPixels = 0` - No gaps between views

4. **Background**: White background (`backColor: [1, 1, 1, 1]`)

5. **Loading method**: Changed to Blob URL approach for reliable NIfTI loading

#### Plots.js - Visualization Updates
1. **Width**: All visualizations (TimeSeries, BrainViewer, FFTSpectrum) set to 800px
2. **Line colors**: Dynamic based on classification
   - Accepted components: Green (#22C55E)
   - Rejected components: Red (#EF4444)

#### TimeSeries.js & FFTSpectrum.js
- Added `lineColor` prop for dynamic coloring
- Default colors updated to match app theme

#### IntroPopUp.js - Mask Loading
- Added detection and loading of mask files (`*_mask.nii*`)
- Passes `maskBuffer` to parent component for optional underlay

### Technical Details
```javascript
// Custom colormaps for diverging display
const white2red = {
  R: [255, 254, 252, 250, 246, 239, 229, 215, 199, 180, 165, 146, 127, 103, 84, 67],
  G: [255, 240, 220, 199, 175, 150, 125, 99, 75, 55, 40, 28, 18, 8, 2, 0],
  B: [255, 237, 214, 190, 165, 140, 114, 89, 68, 50, 38, 28, 20, 13, 7, 3],
  ...
};

const blue2white = {
  R: [5, 24, 47, 75, 103, 134, 162, 186, 206, 222, 235, 244, 250, 253, 254, 255],
  G: [48, 78, 111, 143, 173, 197, 217, 232, 243, 250, 253, 254, 254, 254, 255, 255],
  B: [97, 127, 157, 183, 206, 224, 238, 247, 252, 254, 254, 254, 254, 254, 255, 255],
  ...
};
```

### Files Modified
- `src/Plots/BrainViewer.js` - Custom RdBu colormap, multiplanar config, Blob URL loading
- `src/Plots/Plots.js` - Width 800px, dynamic line colors
- `src/Plots/TimeSeries.js` - Added lineColor prop
- `src/Plots/FFTSpectrum.js` - Added lineColor prop
- `src/PopUps/IntroPopUp.js` - Mask file loading
- `src/index.js` - maskBuffer state

### Colormap Evolution
1. Started with `blue2red` built-in colormap
2. Tried `jet` colormap (user disliked green background)
3. Added 0.001 threshold to hide near-zero values
4. Implemented custom RdBu matching matplotlib
5. Split into two half-colormaps for proper diverging display
6. Removed threshold as no longer needed with proper colormap

---

## Session 3.3 - Component Table (2025-12-14)

### Goals
- Add interactive component metrics table below the charts
- Synchronize table selection with chart selection
- Display original metrics data from TSV file

### Changes Made

#### New Component: ComponentTable.js
- Displays full metrics data from the original TSV file
- Columns: Component, Kappa, Rho, Variance %, κ Rank, ρ Rank, Dice FT2, Dice FS0, S/N t, Classification, Tags
- Interactive row selection synced with charts
- Auto-scrolls to selected row when component is selected from charts
- Selected row highlighted with classification color (green/red)
- Rounded corners on row highlight and classification badges
- Fixed-width classification badges for consistent appearance
- Sticky header row with scrollable body (max 350px height)

#### ToggleSwitch.js Fix
- Changed selected text color from white to dark gray (#1f2937) for readability

### Features
- Click table row to select component (updates all charts)
- Click chart point/slice to select component (table scrolls to row)
- Classification updates reflect in table in real-time
- Hover effects on rows
- Responsive scrolling for large datasets

### Files Created
- `src/Plots/ComponentTable.js`

### Files Modified
- `src/Plots/Plots.js` - Import and render ComponentTable
- `src/Plots/ToggleSwitch.js` - Fix text color contrast

---

## Session 3.4 - Modern Navbar and UX Polish (2025-12-14)

### Goals
- Modernize the top navbar with Notion-style design
- Add click-outside-to-close functionality for popups
- Add favicon as logo in navbar
- Fix data path extraction for Info tab

### Changes Made

#### Modern Navbar (index.js)
- **Left section**: Favicon logo (28x28px) + "Rica" text + version badge (v2.0)
- **Center section**: Pill-style tab navigation with gray background container
  - Selected tab has white background with subtle shadow
  - Smooth hover effects on unselected tabs
- **Right section**:
  - "New" button with border and plus icon
  - Icon-only "About" button (cleaner look)
- Clean white background with subtle shadow
- Better spacing and typography

#### Tab Styling (TabFunctions.js)
- Removed underline indicator animation
- Changed to pill-style selected state (white background, rounded corners)
- Simplified component by removing unused refs and effects

#### Click-Outside-to-Close (IntroPopUp.js, AboutPopUp.js)
- Added onClick handler on backdrop to close popup
- Inner card uses stopPropagation() to prevent closing when clicking inside
- Same behavior as clicking the X button

#### Path Extraction Fix (IntroPopUp.js)
- Fixed regex to properly extract output directory from tedana log
- Now searches for "Using output directory:" and extracts full path
- Handles paths with colons correctly

### Files Modified
- `src/index.js` - Modern navbar layout with favicon
- `src/TabFunctions.js` - Pill-style tabs, removed underline
- `src/PopUps/IntroPopUp.js` - Click-outside-to-close, path extraction fix
- `src/PopUps/AboutPopUp.js` - Click-outside-to-close

---

## Session 3.5 - UX Polish and Display Improvements (2025-12-14)

### Goals
- Remove focus outline on chart container
- Format component names for display (replace underscores with spaces)
- Improve pie chart hover behavior (reduce flickering)
- Make table header sticky when scrolling

### Changes Made

#### Focus Outline Removal (Plots.js)
- Added `outline: "none"` and `boxShadow: "none"` inline styles
- Added Tailwind classes `focus:outline-none focus:ring-0`
- Prevents blue outline when using keyboard navigation (arrow keys)

#### Component Name Formatting (PlotUtils.js)
- New utility function `formatComponentName()` - converts "ICA_01" to "ICA 01"
- Applied to:
  - ScatterPlot tooltips
  - PieChart tooltips
  - ComponentTable Component column
  - TimeSeries title
  - BrainViewer title
- Original names preserved for saving manual classifications

#### Pie Chart Hover Improvements (PieChart.js)
- Changed from `onMouseEnter` to `onMouseMove` for more reliable detection
- Removed scale effect on hover (only selected slices scale now)
- Hovered slices show gray border instead of scaling (prevents flickering)
- Added `onMouseLeave` to parent Group for proper cleanup

#### Sticky Table Header (ComponentTable.js)
- Applied sticky positioning to each `th` element with inline styles
- Position: sticky, top: 0, backgroundColor: #f3f4f6, zIndex: 10
- Header stays visible when scrolling through component rows

### Files Modified
- `src/Plots/Plots.js` - Focus outline removal, component label formatting
- `src/Plots/PlotUtils.js` - New formatComponentName() function
- `src/Plots/ScatterPlot.js` - Import and use formatComponentName for tooltips
- `src/Plots/PieChart.js` - Import and use formatComponentName, improved hover
- `src/Plots/ComponentTable.js` - Import and use formatComponentName, sticky header

---

## Session 3.6 - Final Polish (2025-12-14)

### Goals
- Fix pie chart selected slice displacement
- Add wrap-around navigation for arrow keys
- Remove focus outline from brain viewer

### Changes Made

#### Pie Chart Selection (PieChart.js)
- Removed scale transform on selected slices (was causing displacement)
- Selected slice now stays in place while appearing on top of neighbors
- Visual selection indicators: thicker dark border (3px) and drop shadow
- Slice rendered last in SVG order to appear on top

#### Arrow Key Wrap-Around (Plots.js)
- Left arrow at first component now wraps to last component
- Right arrow at last component now wraps to first component
- Enables continuous circular navigation through pie chart order

#### Brain Viewer Focus Outline (BrainViewer.js)
- Added `outline: "none"` to canvas element
- Prevents blue focus outline when using keyboard navigation

### Files Modified
- `src/Plots/PieChart.js` - Removed scale transform, kept border/shadow selection
- `src/Plots/Plots.js` - Wrap-around logic for arrow key navigation
- `src/Plots/BrainViewer.js` - Canvas outline removal

---

## Session 4 - Colormap and Saturation Controls (2025-12-15)

### Goals
- Change brain viewer colormap to warm/cool diverging scheme
- Add user-adjustable saturation slider for colormap range
- Fix initialization order to apply colormap correctly on first load

### Changes Made

#### BrainViewer.js - Colormap Updates
1. **Using NiiVue's built-in colormaps**:
   - `warm` colormap for positive values (orange/red tones)
   - `cool` colormap for negative values (cyan/blue tones)

2. **Added saturation prop**:
   - Accepts saturation value (0.01 to 1.0) to control colormap range
   - Range calculated as `maxAbs * saturation`
   - Stored `maxAbsRef` for dynamic saturation adjustments

3. **Fixed initialization order**:
   - Set frame with `setFrame4D` BEFORE setting colormap range
   - Call `updateGLVolume()` and `drawScene()` after setting range
   - Ensures correct colormap/saturation on first load

4. **Reduced spacing between brain views**:
   - `multiplanarPadPixels = -30` for tighter layout

#### Plots.js - Saturation Slider
1. **Added saturation state**: `colormapSaturation` with default 0.1 (10%)
2. **Slider UI**:
   - Range slider from 1% to 100%
   - Positioned between brain viewer and FFT chart
   - Shows current percentage value
   - 400px width, centered with brain viewer

3. **Layout fix**:
   - Right side container changed from 50% to 800px width
   - Matches chart width for proper centering

### Files Modified
- `src/Plots/BrainViewer.js` - Colormap, saturation prop, initialization order
- `src/Plots/Plots.js` - Saturation slider UI, layout width fix

### Technical Notes
- Saturation slider updates colormap range in real-time without reinitializing NiiVue
- White background maintained by setting `opts.backColor` before `drawScene()`

---

## Session 5 - Popup Modernization (2025-12-15)

### Goals
- Modernize IntroPopUp and AboutPopUp with Notion-inspired design
- Fix popup centering issues
- Update styling to match app theme

### Changes Made

#### IntroPopUp.js - Modern Redesign
1. **Notion-inspired styling**:
   - Clean modal with dark overlay (`rgba(0, 0, 0, 0.4)`)
   - Proper centering using fixed positioning with flexbox
   - Subtle shadow and 8px border radius
   - 480px max width

2. **Updated content**:
   - Changed description to reference only tedana (removed aroma)
   - Privacy notice with lock emoji
   - Sky-500 accent color (`#0ea5e9`) for button

3. **Improved close button**:
   - Small 28px square button with hover effect
   - Clean X icon

#### AboutPopUp.js - Modern Redesign
1. **Same Notion-inspired styling**:
   - Consistent with IntroPopUp design
   - 440px max width
   - Dark GitHub button (`#111827`)

2. **Fixed version display**:
   - Hardcoded v2.0.0

#### Plots.js - Slider Focus Fix
- Removed focus outline from saturation slider

### Files Modified
- `src/PopUps/IntroPopUp.js` - Complete redesign with inline styles
- `src/PopUps/AboutPopUp.js` - Complete redesign with inline styles
- `src/Plots/Plots.js` - Slider outline removal
- `src/styles/tailwind.css` - Added fadeInScale keyframes (unused after redesign)

---

## Session 6 - Theme System and UI Refinements (2025-12-18)

### Goals
- Implement light/dark mode toggle with localStorage persistence
- Update all components to support theming
- Polish UI with Inter font and consistent styling
- Fix various visual inconsistencies

### Changes Made

#### Theme System Implementation
1. **src/styles.css** - Added CSS custom properties for theming:
   - Light mode (default): White backgrounds, dark text
   - Dark mode: Near-black backgrounds (#0a0a0b), light text
   - Theme-aware accent colors for accepted/rejected states
   - Smooth transition class for theme switching (0.35s cubic-bezier)

2. **src/index.js** - Theme state management:
   - `theme` state with localStorage persistence ('rica-theme')
   - `toggleTheme()` callback with transition class handling
   - `isTransitioning` state for smooth CSS transitions
   - `ThemeContext` provider for child components

3. **public/index.html** - Font updates:
   - Changed from DM Sans to Inter font
   - Kept JetBrains Mono for monospace elements

#### Component Updates for Theme Support
- **src/Plots/Plots.js** - Theme-aware color function `getColors(isDark)`
- **src/Plots/ScatterPlot.js** - Dark chart backgrounds in dark mode
- **src/Plots/PieChart.js** - Theme-aware colors
- **src/Plots/TimeSeries.js** - Theme-aware line colors
- **src/Plots/FFTSpectrum.js** - Theme-aware line colors
- **src/Plots/BrainViewer.js** - Niivue background changes with theme (RGBA 0-1)
- **src/Plots/ComponentTable.js** - Theme-aware table styling
- **src/Plots/ToggleSwitch.js** - Theme-aware toggle
- **src/Plots/ResetAndSave.js** - Theme-aware buttons
- **src/PopUps/IntroPopUp.js** - Theme support, matching branding with AboutPopUp
- **src/PopUps/AboutPopUp.js** - Theme support
- **src/Info/Info.js** - Theme support
- **src/Carpets/Carpets.js** - Theme support
- **src/Mobile.js** - Theme support
- **src/LoadingSpinner.js** - Theme support
- **src/TabFunctions.js** - Theme support

#### UI Polish
1. **ComponentTable.js**:
   - Limited width to 80% and centered on wide screens
   - Fixed text color consistency across all columns
   - Fixed text contrast on selected rows (dark text on colored background)

2. **IntroPopUp.js**:
   - Updated branding to match AboutPopUp exactly (shows "v2.0.0")
   - Fixed alignment of logo, name, and version

3. **Theme Toggle Button**:
   - Sun/moon icon in navbar
   - Smooth icon transition between modes

### Technical Details
```javascript
// Theme-aware colors pattern used throughout
const getColors = (isDark) => ({
  accepted: isDark ? "#4ade80" : "#86EFAC",
  rejected: isDark ? "#f87171" : "#FCA5A5",
  // ...
});

// Niivue background (RGBA 0-1 scale)
const niivueBgColor = useMemo(() =>
  isDark ? [0.09, 0.09, 0.11, 1] : [1, 1, 1, 1],
  [isDark]
);
```

### Files Modified
- `src/styles.css` - Theme variables and transitions
- `src/index.js` - Theme state and toggle
- `public/index.html` - Inter font
- `src/Plots/*.js` - All plot components updated for theming
- `src/PopUps/*.js` - Both popups updated
- `src/Info/Info.js`, `src/Carpets/Carpets.js`, `src/Mobile.js`
- `src/LoadingSpinner.js`, `src/TabFunctions.js`

### Additional Updates
- **BrainViewer saturation default**: Changed from 10% to 25% for better initial visibility

---

## Session 7 - Local Server for Automatic Data Loading (2025-12-18)

### Goals
- Enable automatic data loading when running locally via Python server
- Eliminate need for manual folder selection when serving tedana output
- Create portable server script for distribution with builds

### Architecture

**User Flow:**
1. User copies `index.html` and `rica_server.py` to tedana output folder
2. User runs `python rica_server.py`
3. Server starts on port 8000 and opens browser
4. React app detects localhost, fetches file list from `/api/files`
5. Data auto-loads without any user interaction

### Files Created

**scripts/rica_server.py** - Python HTTP server with:
- CORS headers for cross-origin requests
- `/api/files` endpoint returning JSON list of Rica-relevant files
- Recursive file scanning for files in subdirectories (e.g., `figures/`)
- Auto-opens browser on start
- No external dependencies (Python stdlib only)
- Command-line options: `--port`, `--no-open`

### Files Modified

**src/PopUps/IntroPopUp.js**:
- Added `loadFromServer()` function for HTTP-based file loading
- Added `useEffect` hook to detect localhost and auto-load
- Uses `fetch()` API instead of `FileReader` for HTTP loading
- Reuses existing parsing logic (Papa Parse, ArrayBuffer handling)
- Added `blobToDataURL()` helper for image files

**scripts/build.sh**:
- Copies `rica_server.py` to `build/` directory after build
- Added usage instructions for tedana integration

### API Endpoint

```
GET /api/files
Response: {
  "files": ["figures/comp_001.png", "desc-ICA_metrics.tsv", ...],
  "path": "/absolute/path/to/folder",
  "count": 47
}
```

### Technical Details

```python
# Server file patterns
RICA_FILE_PATTERNS = [
    "_metrics.tsv", "_mixing.tsv", "stat-z_components.nii.gz",
    "_mask.nii", "report.txt", "comp_", ".svg", "tedana_"
]
```

```javascript
// Auto-detection in React
useEffect(() => {
  if (window.location.hostname === "localhost") {
    fetch("/api/files")
      .then(r => r.json())
      .then(data => {
        if (data.files?.length > 0) {
          loadFromServer(data.files, data.path);
        }
      });
  }
}, []);
```

### Usage

```bash
# Build with inline assets
./scripts/build.sh --inline

# Copy to tedana output folder
cp build/index.html build/rica_server.py build/favicon.ico /path/to/tedana/output/

# Run server
cd /path/to/tedana/output/
python rica_server.py
# Browser opens automatically, data loads automatically
```

### Bug Fixes During Implementation

1. **React error #299 (DOM not ready)**: Inline scripts in `<head>` ignore `defer` attribute. Fixed by wrapping React mount in `DOMContentLoaded` check.

2. **Chunk loading errors**: React's lazy loading creates separate chunk files that don't exist in tedana folder. Fixed by removing lazy loading - all code now in single bundle.

3. **Server logging crash**: `log_message` method crashed on Python 3.13 when handling HTTPStatus objects. Fixed with safe string conversion.

4. **Missing favicon**: Added favicon.ico to build output for local server usage.

5. **"New" button loop**: Clicking "New" on local server caused infinite reload loop. Fixed by hiding "New" button when running from local server (`isLocalServer` state).

### Key Code Changes

**src/index.js**:
- Removed lazy loading (`React.lazy`) for single-file distribution
- Added `DOMContentLoaded` check for inline script compatibility
- Added `isLocalServer` state to detect local server mode
- Hide "New" button when `isLocalServer` is true

**scripts/rica_server.py**:
- Fixed `log_message` to safely handle HTTPStatus objects
- Improved error handling for robustness

**scripts/build.sh**:
- Copies `favicon.ico` alongside `index.html` and `rica_server.py`

---

## Session 8 - Tedana Report Parity: Reference Lines (2026-01-07)

### Goals
- Analyze tedana static HTML report to identify missing features in Rica
- Implement missing visualization features to match tedana reports
- Add elbow threshold lines and reference lines like tedana's Bokeh plots

### Analysis
Compared Rica's current implementation with tedana's `tedana_report.html`:

**Rica already had:**
- Kappa vs Rho scatter plot
- Kappa Rank scatter plot
- Rho Rank scatter plot
- Variance Explained pie chart
- Component viewer (PNG or Niivue + time series + FFT)
- Carpet plots (in Carpets tab)

**Missing from tedana reports (now added):**
1. Kappa elbow threshold line (vertical on kappa/rho, horizontal on kappa rank)
2. Rho elbow threshold line (horizontal on kappa/rho, horizontal on rho rank)
3. Diagonal x=y reference line on kappa/rho plot
4. Connecting line through sorted values on rank plots

### Changes Made

#### Data Loading
1. **src/PopUps/IntroPopUp.js**:
   - Added pattern matching for `*_desc-ICACrossComponent_metrics.json`
   - Load and parse cross-component metrics JSON file
   - Pass `crossComponentMetrics` to parent in both server and folder upload modes

2. **src/index.js**:
   - Added `crossComponentMetrics` state
   - Pass to Plots component

3. **scripts/rica_server.py**:
   - Added `CrossComponent_metrics.json` to `RICA_FILE_PATTERNS`

#### Visualization Updates
4. **src/Plots/ScatterPlot.js**:
   - Added new props: `hLine`, `vLine`, `showDiagonal`, `connectingLine`
   - Added theme colors for reference lines (`refLine`, `diagonal`, `connectLine`)
   - Render horizontal threshold line (dashed) when `hLine` provided
   - Render vertical threshold line (dashed) when `vLine` provided
   - Render x=y diagonal reference line when `showDiagonal` is true
   - Render connecting line through data points via `LinePath` when `connectingLine` provided
   - Imported `Line` and `LinePath` from `@visx/shape`

5. **src/Plots/Plots.js**:
   - Added `crossComponentMetrics` prop
   - Extract `kappaElbow` and `rhoElbow` from cross-component metrics
   - Compute `kappaRankLine` and `rhoRankLine` (memoized sorted arrays)
   - Pass elbow lines, diagonal, and connecting lines to ScatterPlot components
   - Renamed "Rho vs Rank" → "Rho Rank", "Kappa vs Rank" → "Kappa Rank"

### Technical Details

**Elbow values from tedana:**
```json
{
  "kappa_allcomps_elbow": 32.26,
  "rho_allcomps_elbow": 12.78
}
```

**Reference lines in ScatterPlot:**
- Horizontal line: Drawn at `yScale(hLine)` across full width
- Vertical line: Drawn at `xScale(vLine)` across full height
- Diagonal: Calculated from intersection of x=y with chart domain bounds
- Connecting line: `LinePath` through sorted rank data points

**Note:** Elbow lines only appear if tedana provides the cross-component metrics JSON.
If the file is missing, the plots still work but without threshold lines.

### Files Modified
- `src/PopUps/IntroPopUp.js` - Load cross-component metrics
- `src/index.js` - Add state and pass props
- `src/Plots/Plots.js` - Extract elbows, compute lines, pass props
- `src/Plots/ScatterPlot.js` - Render reference lines
- `scripts/rica_server.py` - Add file pattern

### Build Status
- Build completed successfully (+600 B to main bundle)

### Next Steps
- In a future session, brainstorm modern webapp design improvements
- Consider adding PCA criterion curves if available
- ~~Consider adding T2*/S0/RMSE visualizations (conditional on data availability)~~ Done in Session 8b

---

## Session 8b - QC Tab for Diagnostic Figures (2026-01-07)

### Goals
- Add a new tab to display diagnostic SVG figures from tedana output
- Organize figures by category (T2*/S0, RMSE, Masks)

### Changes Made

#### Data Loading
1. **src/PopUps/IntroPopUp.js**:
   - Added `diagnosticFigures` array to store non-carpet SVG files
   - Modified SVG loading to separate `carpet_*` files from diagnostic figures
   - Pass `diagnosticFigures` to parent in both server and folder upload modes

2. **src/index.js**:
   - Added `diagnosticFigures` state
   - Added `faHeartPulse` icon import for QC tab
   - Imported `Diagnostics` component
   - Added QC tab (index 3) with heart-pulse icon
   - Added TabPanel for Diagnostics component

#### New Component
3. **src/Diagnostics/Diagnostics.js** (new file):
   - Groups figures by category: "T2* / S0 Maps", "RMSE Quality", "Masks", "Other"
   - Category tabs to switch between figure groups
   - Sub-selector for multiple figures within a category
   - Clean label extraction from filenames
   - Theme-aware styling (light/dark mode support)

### Figures Now Available in QC Tab
| Category | Figures |
|----------|---------|
| T2* / S0 Maps | t2star_brain, t2star_histogram, s0_brain, s0_histogram |
| RMSE Quality | rmse_brain, rmse_timeseries |
| Masks | adaptive_mask |

### Technical Details
- Figures are automatically categorized based on filename patterns
- Empty categories are hidden
- First figure in first non-empty category is auto-selected
- SVG images displayed with responsive sizing

### Files Modified
- `src/PopUps/IntroPopUp.js` - Separate carpet/diagnostic SVGs
- `src/index.js` - Add state, tab, and component
- `src/Diagnostics/Diagnostics.js` - New component (created)

### Build Status
- Development server compiles successfully
- No blocking errors

---

## Session 8c - Niivue Brain Maps in QC Tab (2026-01-07)

### Goals
- Replace static SVG brain figures with interactive Niivue viewers
- Display mosaic view with 5-6 slices per orientation (axial, sagittal, coronal) in rows
- Add colorbar and saturation slider for brain maps
- Make number of slices responsive to screen width

### Changes Made

#### Data Loading
1. **src/PopUps/IntroPopUp.js**:
   - Added patterns for QC NIfTI files: `T2starmap.nii`, `S0map.nii`, `rmse_statmap.nii`
   - Created `qcNiftiBuffers` object to store NIfTI ArrayBuffers by type
   - Pass `qcNiftiBuffers` to parent component

2. **src/index.js**:
   - Added `qcNiftiBuffers` state
   - Pass to Diagnostics component

3. **scripts/rica_server.py**:
   - Added file patterns: `T2starmap.nii`, `S0map.nii`, `rmse_statmap.nii`

#### New Component
4. **src/Diagnostics/NiivueMosaic.js** (new file):
   - Niivue-based brain viewer with mosaic display
   - Shows multiple slices per orientation (axial, sagittal, coronal in rows)
   - Dynamic slice count based on container width (5-8 slices, min 5)
   - Colorbar included via Niivue's `showColorbar: true`
   - Saturation slider (10%-100%) to adjust colormap range
   - Theme-aware styling (light/dark mode support)
   - Appropriate colormaps per map type:
     - T2*/S0: `gray` colormap
     - RMSE: `hot` colormap
     - Mask: `blue` colormap
   - Responsive to window resize via ResizeObserver
   - Loading and error states

#### Updated Component
5. **src/Diagnostics/Diagnostics.js**:
   - Added "Brain Maps" category with T2*, S0, RMSE map tabs
   - Brain maps use NiivueMosaic component instead of SVG
   - Non-brain SVGs (histograms, timeseries) still use image display
   - Increased height to 600px for 3 rows of brain slices

### Technical Details

**Mosaic string generation:**
```javascript
function generateMosaicString(numSlices) {
  // Evenly spaced from 15% to 85% through volume
  const positions = [];
  for (let i = 0; i < numSlices; i++) {
    const pos = 0.15 + (i / (numSlices - 1)) * 0.7;
    positions.push(pos.toFixed(2));
  }
  // Format: "A pos1 pos2...;S pos1 pos2...;C pos1 pos2..."
  return `A ${positions.join(" ")};S ${positions.join(" ")};C ${positions.join(" ")}`;
}
```

**Dynamic slice count:**
- Container width / 90px to estimate comfortable slice width
- Minimum 5 slices, maximum 8 slices
- Updates on window resize via ResizeObserver

**Saturation control:**
- Stores original `cal_max` value on load
- Adjusts `cal_max` based on slider: `originalMax * saturation`
- Calls `updateGLVolume()` and `drawScene()` to refresh

### Files Modified
- `src/PopUps/IntroPopUp.js` - Load QC NIfTI files
- `src/index.js` - Add state and pass props
- `src/Diagnostics/Diagnostics.js` - Use NiivueMosaic for brain maps
- `src/Diagnostics/NiivueMosaic.js` - New component (created)
- `scripts/rica_server.py` - Add file patterns

### Build Status
- Development server compiles successfully

### Session 8c Update - Interactive Navigation

Added position slider to navigate through the brain:
- **Position slider**: Adjusts which slices are shown (25%-75% range)
- Slices spread across 50% of volume, centered on position
- Mosaic updates in real-time as slider moves
- Each orientation (axial, sagittal, coronal) displayed in separate rows

**Mosaic layout:**
- Row 1: Axial slices (5-7 slices)
- Row 2: Sagittal slices (5-7 slices)
- Row 3: Coronal slices (5-7 slices)

**Controls:**
- Position slider: Navigate through brain (default 50%)
- Saturation slider: Adjust colormap intensity (default 100%)

---

## Session 8d - QC Brain Map Sizing and Polish (2026-01-07)

### Goals
- Fix brain slices appearing too small in QC tab
- Add proper mask support to hide areas outside the brain
- Invert hot colormap for RMSE to make background black
- Reset contrast to 50% when switching maps

### Changes Made

#### Diagnostics.js
- Removed maxWidth constraint, now uses full width for better brain visibility
- Container uses `flex: 1` and `minHeight: 500px` to fill available space
- Pass `maskBuffer` to NiivueMosaic for brain masking

#### NiivueMosaic.js
- Fixed at 7 slices per row for good visibility
- Canvas uses `flex: 1` with `minHeight: 400px` to fill parent container
- Container has `height: 100%` and `flex: 1` for proper sizing
- Added `maskBuffer` prop for brain masking (attempted modulation approach)
- Added `getGamma()` function for map-specific gamma values
- Added `colormapInvert` for RMSE maps - inverts hot colormap so high values (outside brain) appear black
- Added `useEffect` to reset contrast to 50% when `mapType` changes
- Calls `updateGLVolume()` and `drawScene()` after setting colormap properties

#### Colormap Configuration
- T2*/S0: `gray` colormap, gamma 1.0
- RMSE: `hot` colormap with `colormapInvert: true`, gamma 1.5
- Mask: `blue` colormap

### Technical Details
```javascript
// Invert colormap for RMSE so high values are black (outside brain)
if (isRmse) {
  vol.colormapInvert = true;
}

// Update the volume rendering
nv.updateGLVolume();
nv.drawScene();
```

### Files Modified
- `src/Diagnostics/Diagnostics.js` - Container sizing, mask prop
- `src/Diagnostics/NiivueMosaic.js` - Sizing, colormap inversion, contrast reset

---

## Session 9 - ICA Page Mosaic View (2026-01-07)

### Goals
- Add mosaic view to ICA page brain viewer (same as QC page)
- Display 7 slices per orientation (axial, sagittal, coronal) in 3 rows
- Add position slider to navigate through brain slices

### Changes Made

#### BrainViewer.js - Mosaic View Implementation
1. **Replaced multiplanar view with mosaic string view**:
   - Changed from `setSliceType(nv.sliceTypeMultiplanar)` to `setSliceMosaicString()`
   - Now displays 7 slices per orientation in 3 rows (axial, sagittal, coronal)
   - Uses same `generateMosaicString()` function as NiivueMosaic

2. **Added position slider**:
   - Allows navigation through brain slices (-40% to +40%)
   - Slider positioned at bottom of viewer
   - Real-time mosaic updates as slider moves

3. **Updated styling**:
   - Black background for better brain visibility (same as QC page)
   - Increased default height to 500px to accommodate 3 rows
   - Added slider theming for light/dark mode

4. **Added state management**:
   - `sliceOffset` state for position slider
   - `volumeExtents` state for mosaic generation
   - Effect hook to update mosaic when offset changes

#### Plots.js - Layout Updates
1. **Increased BrainViewer height**: 350px → 500px
2. **Reduced padding on saturation slider**: 8px → 4px

### Technical Details
```javascript
// Mosaic string format for 3 rows of slices
// "A -40 -20 0 20 40 60 80 ; S ... ; C ..."
function generateMosaicString(numSlices, extents, offset) {
  // Calculate slice positions based on volume extents
  // Offset shifts center position for navigation
}
```

### Files Modified
- `src/Plots/BrainViewer.js` - Added mosaic view, position slider
- `src/Plots/Plots.js` - Increased viewer height

### Build Status
- Build completed successfully (+2.79 KB to main bundle)

### Session 9.1 - Styling Polish

#### Changes Made
1. **Title contrast fix**: Changed title color to `#fafafa` (always light) for better visibility on black background
2. **Slider consistency**: Both position and saturation sliders now use the same styling:
   - Blue accent color (`#3b82f6`)
   - Same max width (200px)
   - Consistent label styling and spacing

#### Files Modified
- `src/Plots/BrainViewer.js` - Title color, slider styling
- `src/Plots/Plots.js` - Saturation slider styling to match position slider

---

## Session 10 - External Regressors Support (2026-01-07)

### Goals
- Add support for external regressor correlation figures from tedana
- Complete feature parity with tedana static HTML report

### Analysis
Compared Rica's implementation with tedana's `tedana_report.html` for external regressors test:

**Already implemented in Rica:**
- ICA components plots (Kappa/Rho, Variance Explained pie, Kappa Rank, Rho Rank)
- Kappa/Rho elbow threshold lines and reference lines
- Carpet plots (optcom, denoised, accepted, rejected)
- Adaptive mask visualization
- T2*/S0 figures (brain maps, histograms)
- RMSE figures (brain map, timeseries)

**Missing (now added):**
- External Regressors category in QC tab for `confound_correlations.svg`

### Changes Made

#### Diagnostics.js
1. Added "External Regressors" category to `groupFigures()` function
2. Files containing "confound" or "external" in the name are now grouped under this category
3. Category only appears when external regressor figures are present

### Files Modified
- `src/Diagnostics/Diagnostics.js` - Added External Regressors category for confound correlation figures

### Test Data Used
- Generated tedana external regressors test output at:
  `/Users/eurunuela/GitHub/tedana/.testing_data_cache/outputs/three-echo-externalreg-Ftest/`
- Contains 43 ICA components and `confound_correlations.svg`

### Build Status
- Build completed successfully (+21 B to main bundle)

### Feature Parity Status
Rica now has full feature parity with tedana's static HTML report. All figures generated by tedana are now displayable in Rica:

| Figure Type | Rica Support |
|-------------|-------------|
| ICA scatter plots | ✓ ICA tab |
| Variance pie chart | ✓ ICA tab |
| Elbow threshold lines | ✓ ICA tab |
| Component images | ✓ ICA tab |
| Time series (mixing) | ✓ ICA tab |
| FFT spectrum | ✓ ICA tab |
| Brain stat maps | ✓ ICA tab (Niivue) |
| Carpet plots | ✓ Carpets tab |
| T2*/S0 brain maps | ✓ QC tab (Niivue) |
| T2*/S0 histograms | ✓ QC tab |
| RMSE brain map | ✓ QC tab (Niivue) |
| RMSE timeseries | ✓ QC tab |
| Adaptive mask | ✓ QC tab |
| External regressors | ✓ QC tab (static SVG) |

---

## Session 10.1 - External Regressors Feature Analysis (2026-01-07)

### Analysis

Investigated implementing an interactive heatmap for external regressor correlations. Found that:

1. **tedana computes correlations** in `plot_heatmap()` via `_correlate_dataframes()`
2. **Only the SVG is saved** - the correlation matrix data is discarded
3. **External regressors are user input** - not saved to tedana output

### Decision

Rather than having Rica re-compute correlations (which requires users to copy their external regressors file), opened a feature request for tedana to save the correlation data.

### GitHub Issue Created
- **tedana#1294**: "Save external regressor correlation data alongside SVG figure"
- URL: https://github.com/ME-ICA/tedana/issues/1294

### Current State
- Rica displays static `confound_correlations.svg` in QC tab (External Regressors category)
- Interactive heatmap will be added once tedana provides the correlation data

### Next Steps (blocked on tedana#1294)
1. tedana saves `confound_correlations.json` with correlation matrix
2. Rica loads the JSON and displays interactive heatmap in ICA tab
3. Features: hover tooltips, click to select component, sync with other plots

---

## Session 11 - Interactive External Regressor Correlation Heatmap (2026-01-09)

### Goals
- Implement interactive heatmap for external regressor correlations
- Use new tedana feature from PR #1297 that saves correlation data in metrics TSV

### Background
- GitHub Issue #1294 requested tedana save correlation data alongside SVG
- Tedana PR #1297 implemented this by adding columns like `external regressor correlation Mot_X` directly to the metrics TSV file
- Rica can now display an interactive heatmap without recomputing correlations

### Changes Made

#### New Component
1. **src/Plots/CorrelationHeatmap.js** (new file):
   - visx-based interactive heatmap visualization
   - Rows: ICA components (y-axis)
   - Columns: External regressors (x-axis with rotated labels)
   - Diverging color scale: blue (negative) → white (zero) → red (positive)
   - Click on cell to select component (syncs with all other plots)
   - Hover tooltips showing component name, regressor name, and correlation value
   - Selected row highlighted with border
   - Color legend bar on right side (-1 to 1)
   - Theme-aware (light/dark mode support)
   - Dynamic sizing based on number of components and regressors

#### Updated Files
2. **src/Plots/Plots.js**:
   - Import CorrelationHeatmap component
   - Added `externalRegressorColumns` useMemo to extract columns containing "external regressor correlation"
   - Added `hasExternalRegressorData` flag to check if correlation data exists
   - Conditional rendering: interactive heatmap when data exists, fallback to static SVG otherwise
   - Heatmap syncs with component selection via `handlePointClick`

### Technical Details

**Column Detection:**
```javascript
const externalRegressorColumns = useMemo(() => {
  if (!componentData?.[0]?.length) return [];
  const firstComponent = componentData[0][0];
  return Object.keys(firstComponent).filter(key =>
    key.toLowerCase().includes('external regressor correlation')
  );
}, [componentData]);
```

**Color Scale Implementation:**
- Uses interpolated RGB values for smooth gradient
- Blue for negative correlations (r < 0)
- Red for positive correlations (r > 0)
- White at zero (r = 0)
- Different intensity ranges for light/dark themes

**Dynamic Sizing:**
- Width: `Math.min(1200, 100 + columns * 80 + 60)` pixels
- Height: `Math.min(800, 160 + rows * 20)` pixels
- Ensures heatmap is readable for both small and large datasets

### Files Created
- `src/Plots/CorrelationHeatmap.js`

### Files Modified
- `src/Plots/Plots.js`

### Build Status
- Compiled successfully with no warnings

### Interaction Features
- Click cell → selects component (updates scatter plots, pie chart, brain viewer, table)
- Hover → tooltip with component name, regressor name, correlation value
- Selected component row highlighted with dark border
- Scroll to zoom (inherited from visx if needed in future)

### Backward Compatibility
- If tedana output doesn't have correlation columns, falls back to static SVG display
- Works with both new tedana outputs (with correlation data) and old outputs (SVG only)

### Session 11.1 - Heatmap Polish (2026-01-09)

**Issues Fixed:**
1. Colorbar was overlapping heatmap
2. Colors were too weak/pastel

**Changes:**
1. **Colorbar positioning**: Increased right margin from 40px to 100px, repositioned colorbar to `margin.left + innerWidth + 20` so it sits cleanly to the right of the heatmap
2. **More saturated colors**:
   - Blue (negative): Now uses vibrant blue (rgb 50,100,220 at -1) instead of pastel
   - Red (positive): Now uses strong red (rgb 255,50,50 at +1) instead of pastel
   - White at zero correlation
3. **Updated width calculation**: Increased max width from 1200px to 1400px to accommodate colorbar

**Files Modified:**
- `src/Plots/CorrelationHeatmap.js` - Colors, margins, colorbar position
- `src/Plots/Plots.js` - Width calculation

---

## Session 12 - Embedded Logo and Version Management (2026-01-10)

### Goals
- Fix logo not rendering when using local build with tedana
- Centralize version management across package.json, UI, and release tags
- Update README to reflect current version and features

### Changes Made

#### Embedded Logo (Self-Contained Build)
1. **src/constants/logo.js** (new file):
   - Created LOGO_DATA_URL constant with favicon encoded as base64 data URL
   - Eliminates need for external favicon.ico file in local deployments
   - ~20KB embedded, well-compressed by gzip

2. Updated components to use embedded logo:
   - **src/index.js** - Navbar logo
   - **src/PopUps/IntroPopUp.js** - Intro popup logo
   - **src/PopUps/AboutPopUp.js** - About popup logo
   - **src/Mobile.js** - Mobile fallback logo

#### Centralized Version Management
3. **src/constants/version.js** (new file):
   - Imports version from package.json at build time
   - Exports VERSION and VERSION_DISPLAY constants
   - Single source of truth for version across entire app

4. Updated components to use centralized version:
   - **src/PopUps/IntroPopUp.js** - Uses VERSION_DISPLAY
   - **src/PopUps/AboutPopUp.js** - Uses VERSION_DISPLAY

#### Build System Updates
5. **scripts/build.sh**:
   - Removed favicon.ico copy step (no longer needed)
   - Updated usage instructions

6. **.github/workflows/build.yml**:
   - Removed favicon.ico from artifacts and releases
   - Simplified copy step

#### Documentation Updates
7. **README.md**:
   - Reorganized features section (ICA, QC, UX categories)
   - Added QC tab features
   - Added external regressor heatmap mention
   - Updated local server instructions (no favicon.ico needed)
   - Added Versioning section with npm version commands
   - Updated Required Files table

### Technical Details
```javascript
// Logo is now embedded as base64
import { LOGO_DATA_URL } from "./constants/logo";
<img src={LOGO_DATA_URL} alt="Rica logo" />

// Version is imported from package.json
import { VERSION_DISPLAY } from "./constants/version";
<p>{VERSION_DISPLAY}</p> // Shows "v2.0.0"
```

### Files Created
- `src/constants/logo.js` - Embedded favicon as base64 data URL
- `src/constants/version.js` - Centralized version management

### Files Modified
- `src/index.js` - Import and use LOGO_DATA_URL
- `src/Mobile.js` - Import and use LOGO_DATA_URL
- `src/PopUps/IntroPopUp.js` - Import LOGO_DATA_URL and VERSION_DISPLAY
- `src/PopUps/AboutPopUp.js` - Import LOGO_DATA_URL and VERSION_DISPLAY
- `scripts/build.sh` - Remove favicon.ico copy
- `.github/workflows/build.yml` - Remove favicon.ico from artifacts
- `README.md` - Updated features, instructions, versioning docs

### Build Impact
- Main bundle increased by ~4.15 KB (embedded base64 logo)
- Fully self-contained single-file distribution
- No external assets required for local deployment

---

## Session 13 - PR Review Fixes (2026-01-10)

### Goals
- Address PR review comments about command injection vulnerabilities in shell scripts

### PR Review Comments Addressed

#### 1. scripts/test.sh - Command Injection (Already Fixed)
- **Issue**: `eval $CMD` with user-controlled `TEST_FILE` argument allowed command injection
- **Status**: Already fixed in a previous commit using bash array (`ARGS=()`) with safe expansion (`"${ARGS[@]}"`)

#### 2. scripts/lint.sh - Command Injection (Fixed)
- **Issue**: String concatenation of `CMD` with unvalidated `TARGET` argument allowed injection
- **Fix**: Converted from string concatenation to bash array approach:
  ```bash
  # Before (vulnerable)
  CMD="npx eslint"
  CMD="$CMD --ext .js,.jsx $TARGET"
  $CMD

  # After (safe)
  CMD=(npx eslint)
  CMD+=("--ext" ".js,.jsx" "$TARGET")
  "${CMD[@]}"
  ```

### Files Modified
- `scripts/lint.sh` - Fixed command injection vulnerability using bash array

### Technical Details
- Using bash arrays prevents shell metacharacters in arguments from being interpreted
- Array expansion with `"${CMD[@]}"` ensures each element is treated as a separate, properly-quoted argument
- This is the standard pattern for safely building and executing commands with user input

---

## Session 14 - UX Improvements: Toggle and Collapsible Table (2026-01-11)

### Goals
- Implement user feedback from Neurostars forum post
- Add toggle between interactive (Niivue) and static (PNG) brain map visualization
- Make component table collapsible to reduce auto-scroll distraction
- Reduce layout dimensions for better screen fit

### User Feedback Addressed
From https://neurostars.org/t/new-version-of-rica/34989/2:
1. User wanted ability to toggle between new and previous visualization methods
2. Auto-scroll behavior when selecting from pie chart was distracting
3. Interface too large for comfortable single-screen viewing

### Changes Made

#### src/Plots/Plots.js
1. **Added state for view toggle and table collapse**:
   - `useStaticView` state - Toggle between interactive Niivue and static PNG
   - `isTableCollapsed` state - Track component table collapse state

2. **Reduced chart dimensions for better screen fit**:
   - `CHART_WIDTH`: 420px → 360px
   - `CHART_HEIGHT`: 380px → 320px
   - TimeSeries/FFTSpectrum height: 180px → 150px
   - BrainViewer height: 350px → 280px
   - Right panel width: Fixed 800px → 50% (max 800px)

3. **Added View toggle buttons**:
   - "Interactive" and "Static" buttons above brain viewer
   - Only shown when interactive data is available
   - Blue highlight for active selection

4. **Updated ComponentTable props**:
   - Pass `isCollapsed` and `onToggleCollapse` props

#### src/Plots/ComponentTable.js
1. **Added collapsible functionality**:
   - Import FontAwesome chevron icon
   - Accept `isCollapsed` and `onToggleCollapse` props
   - Added clickable header button with chevron that rotates when collapsed
   - Shows component count in header
   - Smooth CSS transition for collapse/expand animation

2. **Modified auto-scroll behavior**:
   - Auto-scroll disabled when table is collapsed
   - Prevents page jump when selecting components from pie chart while collapsed

### Technical Details

**View Toggle Pattern:**
```javascript
{hasInteractiveViews && (
  <div>
    <button onClick={() => setUseStaticView(false)}>Interactive</button>
    <button onClick={() => setUseStaticView(true)}>Static</button>
  </div>
)}
```

**Collapsible Table Pattern:**
```javascript
<button onClick={onToggleCollapse}>
  <FontAwesomeIcon
    icon={faChevronDown}
    style={{ transform: isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)' }}
  />
  Component Metrics ({data.length} components)
</button>
<div style={{ maxHeight: isCollapsed ? '0' : '350px', opacity: isCollapsed ? 0 : 1 }}>
  {/* table content */}
</div>
```

### Files Modified
- `src/Plots/Plots.js` - View toggle, reduced dimensions, table collapse state
- `src/Plots/ComponentTable.js` - Collapsible header, disabled auto-scroll when collapsed

### Build Status
- Compiled successfully (+418 B to main bundle)

### UX Improvements Summary
| Before | After |
|--------|-------|
| Fixed interactive-only view | Toggle between Interactive/Static |
| Always-visible table with auto-scroll | Collapsible table, no scroll when collapsed |
| 420x380px charts, 800px right panel | 360x320px charts, 50% responsive right panel |
| ~2000px+ page height | ~1600px page height (fits better on 1080p screens) |

### Session 14.1 - Accessibility Improvements (2026-01-11)

Addressed Copilot PR review comments for accessibility:

**View Toggle (Plots.js):**
- Added `role="radiogroup"` and `aria-labelledby` to toggle container
- Added `role="radio"`, `aria-checked`, `aria-label` to each option
- Added `tabIndex={0}` and keyboard support (Enter/Space)
- Added `aria-hidden="true"` to decorative sliding indicator

**Saturation Slider (Plots.js):**
- Changed `<span>` label to `<label>` with `htmlFor`
- Added `id="saturation-slider"` to input
- Added `aria-label`, `aria-valuemin`, `aria-valuemax`, `aria-valuenow`

**Collapsible Table (ComponentTable.js):**
- Added `id`, `aria-expanded`, `aria-controls`, `aria-label` to toggle button
- Added `aria-hidden="true"` to chevron icon
- Added `id`, `role="region"`, `aria-labelledby`, `aria-hidden` to table container
- Fixed transition timing: opacity 0.2s → 0.3s (matches maxHeight)

---

## Session 14.2 - Improved Collapsible Table UX (2026-01-12)

### Goals
- Make it more obvious that the component metrics table can be collapsed/expanded
- Maintain consistency with existing UI design patterns

### User Feedback
The chevron-based collapse indicator was too subtle and not obviously clickable.

### Changes Made

#### src/Plots/ComponentTable.js
1. **Replaced chevron with toggle switch**: Removed the small 12px chevron icon that rotated when collapsed
2. **Added pill-style toggle**: Implemented a "Show" / "Hide" toggle switch matching the Interactive/Static pattern:
   - 120px total width (60px per option)
   - 28px height (smaller than main toggle switches for subtlety)
   - Blue sliding indicator (#3b82f6 dark mode, #60a5fa light mode)
   - Theme-aware colors for light/dark modes
3. **Improved layout**:
   - Toggle switch on the left
   - "Component Metrics" title in the center
   - Component count on the right
4. **Maintained accessibility**:
   - `role="radiogroup"` and `role="radio"` for screen readers
   - `aria-checked`, `aria-controls`, `aria-expanded` attributes
   - Keyboard support (Enter/Space keys)
   - Proper ARIA labels

### Technical Details
```javascript
// Toggle switch matches existing pattern
<div role="radiogroup" style={{
  height: '28px',
  backgroundColor: isDark ? '#27272a' : '#e5e7eb',
  borderRadius: '6px',
}}>
  {['Show', 'Hide'].map((val) => (
    <span role="radio" aria-checked={...} ... />
  ))}
  <span style={{ left: isCollapsed ? '0px' : '60px', background: '#3b82f6' }} />
</div>
```

### UX Improvement Summary
| Before | After |
|--------|-------|
| Small 12px chevron icon | Clear "Show"/"Hide" toggle switch |
| Subtle rotation animation | Sliding indicator animation |
| Not obviously clickable | Familiar toggle pattern from elsewhere in app |

### Build Status
- Compiled successfully (-25 bytes from removing FontAwesome icon import)

### Files Modified
- `src/Plots/ComponentTable.js` - Replaced chevron with toggle switch

---

## Session 15 - Simplified Toggle Buttons (2026-01-12)

### Goals
- Address user feedback: reclassified components moving to new classification group makes it hard to track progress
- Simplify all toggle UIs to single buttons (gray when off, blue when active)
- Persist all user preferences in localStorage

### User Feedback
From user: "After reclassifying a component it moves it to sit within either team green or team red, visually this is a nice touch, but it makes it quite tricky to see where you're up to when systematically working through the components. Would it be possible to leave them in place and just change their colour?"

### Changes Made

#### All Three Toggles Simplified to Single Buttons
1. **Regroup button** (above pie chart):
   - Gray by default (components keep original position)
   - Blue when active (components regroup by new classification)
   - Positioned in top-right corner of pie chart

2. **Static button** (above brain viewer):
   - Gray by default (interactive Niivue view)
   - Blue when active (static PNG view)

3. **Hide button** (above component table):
   - Gray by default (table visible)
   - Blue when active (table hidden)

#### localStorage Persistence
All three preferences are now persisted:
- `rica-keep-original-order` - Regroup toggle (default: don't regroup)
- `rica-use-static-view` - Static toggle (default: interactive)
- `rica-table-collapsed` - Hide toggle (default: visible)

### Technical Details
```javascript
// Single button pattern used for all three toggles
<button
  onClick={() => setState(!state)}
  aria-pressed={state}
  style={{
    backgroundColor: state ? '#3b82f6' : (isDark ? '#3f3f46' : '#d1d5db'),
    color: state ? '#fff' : (isDark ? '#a1a1aa' : '#6b7280'),
  }}
>
  Label
</button>
```

### UX Improvement Summary
| Before | After |
|--------|-------|
| Two-option toggle switches | Single buttons (gray/blue) |
| Only keepOriginalOrder persisted | All three preferences persisted |
| Toggle below help text | Regroup button above pie chart |
| Complex toggle switch UI | Simple, minimal buttons |

### Build Status
- Compiled successfully (-354 B from bundle - simpler UI)

### Files Modified
- `src/Plots/Plots.js` - Simplified all toggles, added localStorage persistence
- `src/Plots/ComponentTable.js` - Simplified Hide toggle to single button

### Features Updated
- `keep_original_order_toggle`: Now a single "Regroup" button above pie chart
- `toggle_interactive_static_view`: Now a single "Static" button
- `collapsible_component_table`: Now a single "Hide" button

---

## Session 16 - Logo Format Fix (2026-01-12)

### Goals
- Fix Rica logo not appearing in navbar and IntroPopUp

### Issue
The Rica logo was not rendering because:
- The logo was stored as ICO format (image/x-icon) in base64
- ICO format is not universally supported as `<img>` src in all browsers
- ICO is intended for favicon `<link>` tags, not inline images

### Changes Made
1. **src/constants/logo.js** - Converted embedded logo from ICO to PNG format:
   - Changed MIME type from `data:image/x-icon;base64,...` to `data:image/png;base64,...`
   - Generated 64x64 PNG from the original favicon.ico
   - PNG format has universal browser support for `<img>` elements
   - Reduced file size from ~20KB to ~4KB

### Technical Details
```javascript
// Before (ICO - not reliably rendered in <img>)
export const LOGO_DATA_URL = `data:image/x-icon;base64,...`;

// After (PNG - universal browser support)
export const LOGO_DATA_URL = `data:image/png;base64,...`;
```

### Files Modified
- `src/constants/logo.js` - Changed from ICO to PNG format

### Locations Using Logo
The logo is rendered in:
- Navbar (src/index.js line 198-205)
- IntroPopUp (src/PopUps/IntroPopUp.js line 586-590)
- AboutPopUp (src/PopUps/AboutPopUp.js line 78)
- Mobile view (src/Mobile.js line 27)

---

## Session 17 - Changelog Popup with GitHub Releases (2026-01-12)

### Goals
- Add changelog feature showing release notes when users open a new version
- Make changelog accessible via navbar button (bell icon next to About button)
- Populate changelog from GitHub releases API

### Changes Made

#### New Component
1. **src/PopUps/ChangelogPopUp.js** (new file):
   - Fetches releases from GitHub API (`https://api.github.com/repos/ME-ICA/rica/releases`)
   - Shows last 10 releases with version tag, date, name, and description
   - "Latest" badge on most recent release
   - Links to individual releases and all releases page
   - Loading and error states
   - Theme-aware styling (light/dark mode support)
   - Markdown-style body parsing (bold, bullet points, links)
   - `onVersionSeen` callback to track when user has seen the changelog

#### Updated Files
2. **src/index.js**:
   - Import ChangelogPopup component
   - Import VERSION constant for version tracking
   - Import faBell icon for navbar button
   - Add `showChangelogPopup` state
   - Add `toggleChangelogPopup` callback
   - Add `handleVersionSeen` callback to persist seen version
   - Add `useEffect` to auto-show changelog on new version
   - Add bell icon button in navbar (before About button)
   - Render ChangelogPopup conditionally

### Technical Details

**localStorage Key:**
- `rica-last-seen-version` - Stores the last version user has seen

**Auto-show Logic:**
```javascript
useEffect(() => {
  if (showTabs && !showIntroPopup) {
    const lastSeenVersion = localStorage.getItem("rica-last-seen-version");
    if (lastSeenVersion !== VERSION) {
      setShowChangelogPopup(true);
    }
  }
}, [showTabs, showIntroPopup]);
```

**GitHub API Endpoint:**
- `https://api.github.com/repos/ME-ICA/rica/releases`
- Returns JSON array of release objects
- Limited to last 10 releases for performance

### UX Behavior
| Scenario | Behavior |
|----------|----------|
| First-time user | Changelog auto-shows after data loads |
| Same version reload | Changelog does NOT auto-show |
| New version update | Changelog auto-shows after data loads |
| Manual access | Click bell icon in navbar anytime |

### Files Created
- `src/PopUps/ChangelogPopUp.js`

### Files Modified
- `src/index.js` - Added changelog state, button, and auto-show logic
- `features.json` - Added `changelog_popup` feature
- `claude-progress.txt` - This session documentation

### Build Status
- ESLint passes
- Dev server compiles successfully

---

## Session 18 - Citation Popup with Zenodo DOI (2026-01-12)

### Goals
- Add citation popup that appears when users save manual classification
- Include Zenodo DOI for proper academic citation
- Fetch latest DOI from Zenodo API to stay up to date with releases

### User Request
User wanted to prompt users to cite Rica when they save their manual classifications, similar to how the README includes the Zenodo DOI badge.

### Changes Made

#### New Component
1. **src/PopUps/CitationPopUp.js** (new file):
   - Appears automatically after saving manual classification
   - Fetches latest release info from Zenodo API
   - Shows success message confirming files were saved
   - Displays formatted citation with:
     - Authors (from Zenodo or fallback)
     - Year (from Zenodo or current year)
     - Version (from Zenodo or current app version)
     - DOI (latest version DOI or concept DOI)
   - Copy button to copy citation to clipboard
   - Zenodo DOI badge with link
   - "View on Zenodo" button
   - Theme-aware styling (light/dark mode support)
   - Graceful fallback if Zenodo API unavailable

#### Updated Files
2. **src/Plots/Plots.js**:
   - Import CitationPopUp component
   - Add `showCitationPopup` state
   - Modify `saveManualClassification` to show popup after save
   - Render CitationPopUp conditionally

3. **features.json**:
   - Added `citation_popup` feature with test steps

### Technical Details

**Zenodo API:**
- Concept DOI: `10.5281/zenodo.5788349` (points to all versions)
- API endpoint: `https://zenodo.org/api/records?q=conceptrecid:5788349&sort=-version&size=1`
- Returns latest release metadata including version-specific DOI, authors, and publication date

**Citation Format:**
```
Authors (Year). Rica: Reports for ICA (Version X.X.X). Zenodo. https://doi.org/DOI
```

**Fallback Behavior:**
- If Zenodo API fails, uses cached/default values
- Shows subtle note: "Using cached citation data (Zenodo unavailable)"
- Citation still functional with concept DOI

### Files Created
- `src/PopUps/CitationPopUp.js`

### Files Modified
- `src/Plots/Plots.js`
- `features.json`
- `claude-progress.txt`

### Build Status
- ESLint passes with no errors or warnings
- Dev server compiles successfully

---

## Release v2.0.1 (2026-01-12)

### Release Notes
Created GitHub release v2.0.1 with the following highlights:

**Special thanks to Jon Brooks for his feedback.**

### User Experience Improvements
- Simplified toggle buttons (single buttons, blue when active)
- localStorage persistence for all user preferences
- Regroup toggle for keeping components in place vs regrouping
- Collapsible component table
- Interactive/Static view toggle

### New Features
- Citation popup with Zenodo DOI after saving classifications
- Changelog popup showing GitHub releases on new version
- Interactive external regressor correlation heatmap

### Bug Fixes
- Logo rendering (ICO to PNG conversion)
- Command injection fix in lint.sh

### Release URL
https://github.com/ME-ICA/rica/releases/tag/v2.0.1

---

## Session 19 - Manual Classification Loading (2026-01-13)

### Goals
- Add support for loading existing manual_classification.tsv files
- Show warning popup when folder contains previous manual classifications
- Restore user's previous reclassifications automatically

### Changes Made (PR #83)

#### Data Loading
1. **src/PopUps/IntroPopUp.js**:
   - Added pattern matching for `manual_classification.tsv` files
   - Parse manual classification TSV to detect reclassified components
   - Compare with original metrics to find changed classifications
   - Show warning popup listing all manually reclassified components

2. **src/Plots/PlotUtils.js**:
   - Added helper functions for TSV parsing with null checks
   - Explicit tab delimiter handling for robust parsing
   - Error handling and logging for debugging

3. **src/PopUps/ManualClassificationPopUp.js** (new file):
   - Warning popup component showing list of reclassified components
   - Displays component name, original classification, and new classification
   - "Continue" button to proceed with loading
   - Theme-aware styling (light/dark mode support)

### Technical Details

**File Detection:**
- Looks for `manual_classification.tsv` in the loaded folder
- Compares classification columns between original metrics and manual classification
- Components with changed classifications are flagged

**Warning Popup:**
- Lists each reclassified component with before/after classification
- Helps users understand what previous changes will be applied
- Allows users to proceed with informed consent

### Files Created
- `src/PopUps/ManualClassificationPopUp.js`

### Files Modified
- `src/PopUps/IntroPopUp.js` - Load and parse manual classification
- `src/Plots/PlotUtils.js` - Helper functions for TSV parsing
- `src/index.js` - State management for warning popup

### Features Added
- `load_manual_classification`: Load existing manual_classification.tsv and restore previous reclassifications

### Build Status
- Build completed successfully
- All existing features remain functional

---

## Release v2.0.2 (2026-01-13)

### Release Notes

**New Feature: Load Existing Manual Classifications**

Rica now automatically detects and loads `manual_classification.tsv` files from your tedana output folder. This means:
- Your previous component reclassifications are automatically restored
- A warning popup shows which components were previously reclassified
- You can continue refining your classifications from where you left off

### What's New
- **Manual Classification Loading**: Automatically loads existing `manual_classification.tsv` files
- **Warning Popup**: Shows list of previously reclassified components before loading
- **Robust TSV Parsing**: Improved null checks and explicit tab delimiter handling

### Bug Fixes
- Fixed TSV parsing edge cases with null values
- Added error handling for malformed manual classification files

### Release URL
https://github.com/ME-ICA/rica/releases/tag/v2.0.2

---

## Template for Future Sessions

```
## Session N - [Brief Description] (YYYY-MM-DD)

### Goals
- Goal 1
- Goal 2

### Changes Made
1. **file.js** - Description of changes
2. **file2.js** - Description of changes

### Features Updated
- feature_id: now passes=true (description of test/verification)

### Issues Encountered
- Issue description and resolution

### Next Steps
- Recommended follow-up work
```
